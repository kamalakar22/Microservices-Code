name: Build, Scan, and Push Docker image

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: List files in api-service
      run: ls -la ./api-service

    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build Docker image
      id: build
      run: |
        IMAGE_TAG="${{ secrets.DOCKER_USERNAME }}/api-service:${{ github.run_id }}"
        docker build -t $IMAGE_TAG ./api-service
        echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

    - name: Install Trivy
      run: |
        curl -sSfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh
        echo "Trivy installed to $(pwd)/bin"
        export PATH=$(pwd)/bin:$PATH
        echo "PATH=$PATH" >> $GITHUB_ENV

    - name: Run Trivy scan
      run: |
        trivy image --format json --output trivy-report.json ${{ env.IMAGE_TAG }}

    - name: Upload Trivy report
      uses: actions/upload-artifact@v3
      with:
        name: trivy-report
        path: trivy-report.json

    - name: Push Docker image
      run: |
        docker push ${{ env.IMAGE_TAG }}
    - name: Deploy to Kubernetes
      run: |
        kubectl apply -f deployment.yaml --validate=false

